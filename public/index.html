<html>
    <head>
        <title>client</title>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="primus.js"></script>
        <script>
            const primus = Primus.connect('ws://localhost:6666');

            const state = {
                content: {

                }
            };

            primus.on('data', function(data) {
                console.log(data);
                if (data.type = 'stateUpdate') {
                    Object.keys(data.state.files).forEach(function(file) {
                        if (state.file && state.file[file] && state.file[file] == data.state.files[file]) {

                        }
                        else {
                            if (data.state.files[file].indexOf('.svg') > -1) {
                                state.content[file] = '/data/' + data.state.files[file];
                            }
                            else if (data.state.files[file].indexOf('.png') > -1) {
                                console.log('image change!', file);
                                state.content[file] = '/data/' + data.state.files[file];
                            }
                            else if (data.state.files[file].indexOf('.txt') > -1) {
                                m.request({
                                    method: 'GET',
                                    url: '/data/' + data.state.files[file],
                                    deserialize: function(result) {

                                        return result;
                                    }
                                })
                                .then(function(result) {
                                    state.content[file] = result;
                                })
                            }
                            else {
                                console.log('data change!', file, data.state.files[file]);
                                m.request({
                                    method: 'GET',
                                    url: '/data/' + data.state.files[file]
                                })
                                .then(function(result) {
                                    state.content[file] = result;
                                })
                            }
                        }
                    });

                    state.files = data.state.files;
                }
            });

            primus.on('open', function() {
                primus.write({identity: 'user:bob'})
            })

            const App = {
                view: function() {
                    renderMapData = function(mapData) {
                        return m('div',
                            mapData
                                .filter(function(element) {
                                    return element.type == 'stuff'
                                })
                                .map(function(element) {
                                    return m('div', {
                                        onclick: function() {
                                            console.log('collect', element.name);
                                            primus.write({type: 'collect', target: element.name });
                                        }
                                    }, element.name)
                                })
                        );
                    };

                    return m('main', [
                        m('h1', {}, state.content.info),
                        state.content.cam ? m('img', { src: state.content.cam,  width: 300 }) : undefined,
                        state.content.cam2 ? m('img', { src: state.content.cam2,  width: 300 }) : undefined,
                        state.content.mapData ? renderMapData(state.content.mapData) : undefined,
                        state.content.map ? m('object', { data: state.content.map }) : undefined,
                        state.content.flop ? m('img', { src: state.content.flop }) : undefined
                    ])
                }
            }

        </script>
    </head>
    <body>
        <script>
            m.mount(document.body, App);
        </script>
    </body>
</html>
